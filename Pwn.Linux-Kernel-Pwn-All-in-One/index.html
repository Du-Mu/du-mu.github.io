<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="V3rdant" />
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
  <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
  
  
  
  <title>
    
      Pwn.Linux-Kernel-Pwn-All-in-One 
      
      
      |
    
     V3rdant&#39;s Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WT6LFRH6M0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-WT6LFRH6M0');
    </script>
  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="V3rdant's Blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">V3rdant</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Pwn.Linux-Kernel-Pwn-All-in-One</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-03-03 16:21:36
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/Pwn/" title="Pwn">
                    <b>#</b> Pwn
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Pwn/" title="Pwn">
                    #Pwn
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/linux/" title="linux">
                    #linux
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/CTF/" title="CTF">
                    #CTF
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Kernel/" title="Kernel">
                    #Kernel
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="overview">overview</h1>
<p>ç¬”è€…åŒå€¦äº†ç”¨æˆ·æ€å †çš„ç§ç§tricksï¼Œäºæ˜¯å†³å®šè¿›å…¥kernel pwnçš„å¤§å‘ğŸ˜Š</p>
<h1 id="å®‰å…¨æœºåˆ¶">å®‰å…¨æœºåˆ¶</h1>
<p><strong>CONFIG_CFI_CLANG=y</strong></p>
<p>æ§åˆ¶æµå®Œæ•´æ€§æ ¡éªŒï¼Œé™åˆ¶ROP</p>
<p><strong>CONFIG_SLAB_FREELIST_HARDENED=y</strong></p>
<p>ç±»ä¼¼äºç”¨æˆ·æ€ä¸‹ glibc ä¸­çš„ safe-linking æœºåˆ¶ï¼Œåœ¨å†…æ ¸ä¸­çš„ slab/slub åˆ†é…å™¨å½“ä¸­ä¹Ÿå­˜åœ¨ç€ç±»ä¼¼çš„æœºåˆ¶ä¿æŠ¤ç€ freelistâ€”â€”Â <code>SLAB_FREELIST_HARDENED</code>ï¼š</p>
<p>ç±»ä¼¼äº glibc 2.32 ç‰ˆæœ¬å¼•å…¥çš„ä¿æŠ¤ï¼Œåœ¨å¼€å¯è¿™ç§ä¿æŠ¤ä¹‹å‰ï¼Œslub ä¸­çš„ free object çš„ next æŒ‡é’ˆç›´æ¥å­˜æ”¾ç€ next free object çš„åœ°å€ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è¯»å– freelist æ³„éœ²å‡ºå†…æ ¸çº¿æ€§æ˜ å°„åŒºçš„åœ°å€ï¼Œåœ¨å¼€å¯äº†è¯¥ä¿æŠ¤ä¹‹å free object çš„ next æŒ‡é’ˆå­˜æ”¾çš„æ˜¯ç”±ä»¥ä¸‹ä¸‰ä¸ªå€¼è¿›è¡Œå¼‚æˆ–æ“ä½œåçš„å€¼ï¼š</p>
<ul>
<li>å½“å‰ free object çš„åœ°å€</li>
<li>ä¸‹ä¸€ä¸ª free object çš„åœ°å€</li>
<li>ç”± kmem_cache æŒ‡å®šçš„ä¸€ä¸ª random å€¼</li>
</ul>
<p><strong>CONFIG_HARDENED_USERCOPY=y</strong></p>
<p>hardened usercopy æ˜¯ç”¨ä»¥åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´æ•°æ®æ—¶è¿›è¡Œè¶Šç•Œæ£€æŸ¥çš„ä¸€ç§é˜²æŠ¤æœºåˆ¶ï¼Œ<strong>ä¸»è¦æ£€æŸ¥æ‹·è´è¿‡ç¨‹ä¸­å¯¹å†…æ ¸ç©ºé—´ä¸­æ•°æ®çš„è¯»å†™æ˜¯å¦ä¼šè¶Šç•Œ</strong>ï¼š</p>
<ul>
<li>è¯»å–çš„æ•°æ®é•¿åº¦æ˜¯å¦è¶…å‡ºæº object èŒƒå›´</li>
<li>å†™å…¥çš„æ•°æ®é•¿åº¦æ˜¯å¦è¶…å‡ºç›®çš„ object èŒƒå›´</li>
</ul>
<p>ä¸è¿‡è¿™ç§ä¿æŠ¤Â <em>ä¸é€‚ç”¨äºå†…æ ¸ç©ºé—´å†…çš„æ•°æ®æ‹·è´</em>Â ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„ç»•è¿‡æ‰‹æ®µ</p>
<p>è¿™ä¸€ä¿æŠ¤è¢«ç”¨äºÂ <code>copy_to_user()</code>Â ä¸Â <code>copy_from_user()</code>Â ç­‰æ•°æ®äº¤æ¢ API ä¸­</p>
<p><strong>CONFIG_SLAB_FREELIST_RANDOM=y</strong></p>
<p>è¿™ç§ä¿æŠ¤ä¸»è¦å‘ç”Ÿåœ¨ slub allocator å‘ buddy system ç”³è¯·åˆ°é¡µæ¡†ä¹‹åçš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯¹äºæœªå¼€å¯è¿™ç§ä¿æŠ¤çš„ä¸€å¼ å®Œæ•´çš„ slubï¼Œå…¶ä¸Šçš„ object çš„è¿æ¥é¡ºåºæ˜¯çº¿æ€§è¿ç»­çš„ï¼Œä½†åœ¨å¼€å¯äº†è¿™ç§ä¿æŠ¤ä¹‹åå…¶ä¸Šçš„ object ä¹‹é—´çš„è¿æ¥é¡ºåºæ˜¯éšæœºçš„ï¼Œè¿™è®©æ”»å‡»è€…æ— æ³•ç›´æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªåˆ†é…çš„ object çš„åœ°å€</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§ä¿æŠ¤å‘ç”Ÿåœ¨<strong>slub allocator åˆšä» buddy system æ‹¿åˆ°æ–° slub çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶ freelist çš„æ„æˆä»éµå¾ª LIFO</strong></p>
<p><strong>CONFIG_INIT_ON_ALLOC_DEFAULT_ON=y</strong></p>
<p>å½“ç¼–è¯‘å†…æ ¸æ—¶å¼€å¯äº†è¿™ä¸ªé€‰é¡¹æ—¶ï¼Œåœ¨å†…æ ¸è¿›è¡Œâ€œå †å†…å­˜â€åˆ†é…æ—¶ï¼ˆåŒ…æ‹¬ buddy system å’Œ slab allocatorï¼‰ï¼Œ<strong>ä¼šå°†è¢«åˆ†é…çš„å†…å­˜ä¸Šçš„å†…å®¹è¿›è¡Œæ¸…é›¶</strong>ï¼Œä»è€Œé˜²æ­¢äº†åˆ©ç”¨æœªåˆå§‹åŒ–å†…å­˜è¿›è¡Œæ•°æ®æ³„éœ²çš„æƒ…å†µ</p>
<p><strong>CONFIG_RANDOMIZE_KSTACK_OFFSET</strong></p>
<p>å†³å®šå†…æ ¸æ ˆæ˜¯å¦å­˜åœ¨éšæœºåç§»</p>
<p><strong>CONFIG_MEMCG_KMEM</strong></p>
<p>å†³å®š<code>GFP_KERNEL</code>Â ä¸Â <code>GFP_KERNEL_ACCOUNT</code>Â æ˜¯å¦ä¼šä»åŒæ ·çš„Â <code>kmalloc-xx</code>Â ä¸­è¿›è¡Œåˆ†é…</p>
<p><strong>CONFIG_CFI_CLANG</strong></p>
<p>å†³å®šæ˜¯å¦å¼€å¯CFI(æ§åˆ¶æµå®Œæ•´æ€§)ï¼Œ é™åˆ¶äº†ROP</p>
<p><strong>CONFIG_STATIC_USERMODEHELPER</strong></p>
<p>å†³å®šmodprobe_path æ˜¯å¦å¯å†™</p>
<h1 id="ä¿¡æ¯æœé›†">ä¿¡æ¯æœé›†</h1>
<ol>
<li>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/version</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>æ£€æŸ¥å„ç§åŸºç¡€ä¿æŠ¤</li>
</ol>
<ul>
<li>å¯åŠ¨è„šæœ¬
<ul>
<li>pti=on</li>
<li>smep,smap</li>
<li>kaslr</li>
</ul>
</li>
<li>.config</li>
<li>æ£€æŸ¥åˆ†é…æ–¹å¼</li>
</ul>
<h1 id="Target">Target</h1>
<p>ä»¥ä¸‹éƒ¨åˆ†æ¥è‡ª ctf-wiki, ç¬”è€…ä¼šæ·»åŠ ä¸€äº›è‡ªå·±çš„ç†è§£ã€‚</p>
<h2 id="modify-cred">modify cred</h2>
<p>å†…æ ¸pwnçš„å¤§éƒ¨åˆ†ç›®æ ‡éƒ½æ˜¯å®ç°ææƒï¼Œè€Œä¸€ä¸ªè¿›ç¨‹çš„æƒé™æ˜¯ç”±å…¶å¯¹åº”çš„credç»“æ„ä½“å†³å®šçš„ï¼Œå› æ­¤ã€‚</p>
<p>kernelé€šè¿‡task_struct ä¸­çš„credçš„æŒ‡é’ˆæ¥ç´¢å¼•credç»“æ„ä½“ï¼Œ<br>
æ›´è¿›ä¸€æ­¥åœ°ï¼Œé€šè¿‡credçš„ç»“æ„ä½“æ¥è¯†åˆ«å½“å‰userï¼Œå› æ­¤å¯ä»¥é€šè¿‡ä¿®æ”¹å½“å‰credç»“æ„ä½“æˆ–è€…task_structçš„æŒ‡é’ˆæ¥è¾¾æˆææƒçš„æ•ˆæœã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="type">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="type">void</span>        *put_addr;</span><br><span class="line">    <span class="type">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç›´æ¥å®šä½cred">ç›´æ¥å®šä½cred</h3>
<p>å½“æ‹¥æœ‰å†…å­˜è¯»å†™çš„èƒ½åŠ›åï¼Œå¯ä»¥é€šè¿‡åœ¨å†…å­˜ä¸­æœç´¢magic æ¥æŸ¥æ‰¾credç»“æ„ä½“ã€‚</p>
<p>// ç¬”è€…å°è¯•æœç´¢åï¼Œå‘ç°ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæœ‰äº›credç»“æ„ä½“ï¼Œmagicå­—æ®µä¸ºç©º #TODO</p>
<p>ç¬”è€…ç»™å‡ºå¦ä¸€ä¸ªcredå®šä½æ–¹æ³•ï¼Œåœ¨å†…æ ¸æ€ä¸‹ï¼Œ GS æ®µ å­˜å‚¨ç€è¿›ç¨‹ç›¸å…³æ§åˆ¶ä¿¡æ¯ï¼Œåœ¨å…¶å›ºå®šåç§»ï¼Œå¯ä»¥æ‰¾åˆ°å½“å‰credç»“æ„ä½“çš„æŒ‡é’ˆã€‚</p>
<p>å½“ç„¶ï¼Œæ˜¾ç„¶å¤§éƒ¨åˆ†æƒ…å†µï¼Œæ˜¯åŸºæœ¬ä¸å¯èƒ½æ‰¾åˆ°æ°å¥½è®¿é—®gsç›®æ ‡åç§»åœ°å€çš„gadgetçš„ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•å¹¶ä¸æ˜¯éå¸¸å®ç”¨ã€‚</p>
<h3 id="commit-creds"><code>commit_creds</code></h3>
<p><code>commit_creds()</code>Â å‡½æ•°è¢«ç”¨ä»¥å°†ä¸€ä¸ªæ–°çš„ cred è®¾ä¸ºå½“å‰è¿›ç¨‹ task_struct çš„ real_cred ä¸ cred å­—æ®µï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤ŸåŠ«æŒå†…æ ¸æ‰§è¡Œæµè°ƒç”¨è¯¥å‡½æ•°å¹¶ä¼ å…¥ä¸€ä¸ªå…·æœ‰ root æƒé™çš„ credï¼Œåˆ™èƒ½ç›´æ¥å®Œæˆå¯¹å½“å‰è¿›ç¨‹çš„ææƒå·¥ä½œ</p>
<p>// ç¬”è€…ç›®å‰è¿˜æ²¡æœ‰çœ‹è¿‡<code>commit_creds()</code>çš„æºä»£ç ï¼Œå¹¶ä¸æ¸…æ¥šå¯¹credæœ‰å“ªäº›æ£€æŸ¥<br>
// åœ¨ç¬”è€…çœ‹æ¥ï¼Œå¦‚æœæ²¡æœ‰é™åˆ¶ ä¼ å…¥çš„credså¿…é¡»æ˜¯ç›¸åº” <code>slab_account</code> çš„è¯ï¼Œå…¶å®å¯ä»¥è‡ªå·±æ‰¾ä¸€å—å†…å­˜åŒºåŸŸæ¥å†™</p>
<h4 id="prepare-kernel-cred"><code>prepare_kernel_cred()</code></h4>
<p>åœ¨å†…æ ¸å½“ä¸­æä¾›äº†Â <code>prepare_kernel_cred()</code>Â å‡½æ•°ç”¨ä»¥æ‹·è´æŒ‡å®šè¿›ç¨‹çš„ cred ç»“æ„ä½“ï¼Œå½“æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ä¸º NULL æ—¶ï¼Œè¯¥å‡½æ•°ä¼šæ‹·è´Â <code>init_cred</code>Â å¹¶è¿”å›ä¸€ä¸ªæœ‰ç€ root æƒé™çš„ credï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred *<span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct *daemon)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">    new = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!new)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    kdebug(<span class="string">&quot;prepare_kernel_cred() alloc %p&quot;</span>, new);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (daemon)</span><br><span class="line">        old = get_task_cred(daemon);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        old = get_cred(&amp;init_cred);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ç©ºé—´ä¸­è°ƒç”¨Â <code>commit_creds(prepare_kernel_cred(NULL))</code>ï¼Œåˆ™ä¹Ÿèƒ½ç›´æ¥å®Œæˆææƒçš„å·¥ä½œ</p>
<p>ä¸è¿‡è‡ªä»å†…æ ¸ç‰ˆæœ¬ 6.2 èµ·ï¼Œ<code>prepare_kernel_cred(NULL)</code>Â å°†<strong>ä¸å†æ‹·è´ init_credï¼Œè€Œæ˜¯å°†å…¶è§†ä¸ºä¸€ä¸ªè¿è¡Œæ—¶é”™è¯¯å¹¶è¿”å› NULL</strong>ï¼Œè¿™ä½¿å¾—è¿™ç§ææƒæ–¹æ³•æ— æ³•å†åº”ç”¨äº 6.2 åŠæ›´é«˜ç‰ˆæœ¬çš„å†…æ ¸</p>
<h4 id="init-cred"><code>init_cred</code></h4>
<p>åœ¨å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹å½“ä¸­ä¼šä»¥ root æƒé™å¯åŠ¨Â <code>init</code>Â è¿›ç¨‹ï¼Œå…¶ cred ç»“æ„ä½“ä¸º<strong>é™æ€å®šä¹‰</strong>çš„Â <code>init_cred</code>ï¼Œç”±æ­¤ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡Â <code>commit_creds(&amp;init_cred)</code>Â æ¥å®Œæˆææƒçš„å·¥ä½œ</p>
<p>// ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨é«˜ç‰ˆæœ¬ï¼Œinit_credæœ¬èº«ä¸å†ä½œä¸ºä¸€ä¸ªç¬¦å·å¯¼å‡ºï¼Œå› æ­¤ä½ ç›´æ¥<br>
// <code>kallsyms-finder</code> æ˜¯æ‰¾ä¸åˆ°ç›¸åº”åœ°å€çš„<br>
// ä¸€ä¸ªç›´æ¥çš„æ–¹æ³•æ˜¯ï¼Œåœ¨ç›¸åº”ç‰ˆæœ¬linuxæºä»£ç é‡Œé¢ç›´æ¥æœç´¢ç¬¦å·å¼•ç”¨<br>
// å¯ä»¥åœ¨å†…æ ¸ä»£ç æ®µé‡Œé¢æ‰¾åˆ°ç›¸åº”åœ°å€</p>
<p>// è¿™ä¸ªæ–¹æ³•ä¸ä»…ä»…å¯ä»¥ç”¨äº<code>init_cred</code>ï¼Œä¸€åˆ‡å†…æ ¸dataæ®µçš„åŒ¿åç»“æ„ä½“éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æŸ¥æ‰¾ï¼Œ é™¤éå†…æ ¸åœ¨å†™çš„æ—¶å€™æœ¬èº«å°±æ²¡æœ‰ç›´æ¥è®¿é—®</p>
<h2 id="modprobe-path">modprobe_path</h2>
<p>modprobe æ˜¯linuxçš„ä¸€ä¸ªç”¨äºæ‰§è¡Œä¸ç¡®å®šæ ¼å¼æ–‡ä»¶çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå…¶ä¼šä»¥rootæƒé™ä½¿ç”¨modprobe_pathæŒ‡å‘çš„è§£é‡Šå™¨æ¥å®ç°ç›¸å¯¹åº”çš„ç¨‹åºï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤ŸåŠ«æŒç›¸å…³çš„ç¨‹åºï¼Œå°±èƒ½ä»¥rootæƒé™æ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œä»è€Œææƒ</p>
<ol>
<li>è·å– modprobe_path çš„åœ°å€ã€‚</li>
<li>ä¿®æ”¹ modprobe_path ä¸ºæŒ‡å®šçš„ç¨‹åºã€‚</li>
<li>è§¦å‘æ‰§è¡ŒÂ <code>call_modprobe</code>ï¼Œä»è€Œå®ç°ææƒ ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥è§¦å‘
<ol>
<li>æ‰§è¡Œä¸€ä¸ªéæ³•çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚éæ³•çš„å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦æ»¡è¶³ç›¸åº”çš„è¦æ±‚ï¼ˆå‚è€ƒ call_usermodehelper éƒ¨åˆ†çš„ä»‹ç»ï¼‰ã€‚</li>
<li>ä½¿ç”¨æœªçŸ¥åè®®æ¥è§¦å‘ã€‚</li>
</ol>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// step 1. modify modprobe_path to the target value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// step 2. create related file</span></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag\ncat flag&#x27; &gt; /home/pwn/catflag.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/catflag.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// step 3. trigger it using unknown executable</span></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// step 3. trigger it using unknown protocol</span></span><br><span class="line">socket(AF_INET,SOCK_STREAM,<span class="number">132</span>);</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç€é‡å…³æ³¨ä¸‹å¦‚ä½•å®šä½ modprobe_pathã€‚</p>
<h5 id="ç›´æ¥å®šä½">ç›´æ¥å®šä½</h5>
<p>ç”±äº modprobe_path çš„å–å€¼æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰«æå†…å­˜ï¼Œå¯»æ‰¾å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚è¿™éœ€è¦æˆ‘ä»¬å…·æœ‰æ‰«æå†…å­˜çš„èƒ½åŠ›ã€‚</p>
<h5 id="é—´æ¥å®šä½">é—´æ¥å®šä½</h5>
<p>è€ƒè™‘åˆ° modprobe_path ç›¸å¯¹äºå†…æ ¸åŸºåœ°å€çš„åç§»æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè·å–åˆ°å†…æ ¸çš„åŸºåœ°å€ï¼Œç„¶åæ ¹æ®ç›¸å¯¹åç§»æ¥å¾—åˆ° modprobe_path çš„åœ°å€ã€‚</p>
<h2 id="poweroff-cmd">poweroff_cmd</h2>
<p>ç±»ä¼¼äºmodprobe_path</p>
<ol>
<li>ä¿®æ”¹ poweroff_cmd ä¸ºæŒ‡å®šçš„ç¨‹åºã€‚</li>
<li>åŠ«æŒæ§åˆ¶æµæ‰§è¡ŒÂ <code>__orderly_poweroff</code>ã€‚</li>
</ol>
<p>å…³äºå¦‚ä½•å®šä½ poweroff_cmdï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç±»ä¼¼äºå®šä½Â <code>modprobe_path</code>Â çš„æ–¹æ³•ã€‚</p>
<h1 id="ä¸€äº›å®">ä¸€äº›å®</h1>
<p>ä»¥ä¸‹åˆ—å‡ºäº†å¸¸ç”¨çš„ä¸€äº›å®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_DMA		0x01u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_HIGHMEM		0x02u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_DMA32		0x04u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_MOVABLE		0x08u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_RECLAIMABLE	0x10u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_HIGH		0x20u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_IO		0x40u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_FS		0x80u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ZERO		0x100u</span></span><br><span class="line"><span class="comment">/* 0x200u unused */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_DIRECT_RECLAIM	0x400u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_KSWAPD_RECLAIM	0x800u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_WRITE		0x1000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOWARN		0x2000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_RETRY_MAYFAIL	0x4000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOFAIL		0x8000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NORETRY		0x10000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_MEMALLOC		0x20000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_COMP		0x40000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOMEMALLOC	0x80000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_HARDWALL		0x100000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_THISNODE		0x200000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ACCOUNT		0x400000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_ZEROTAGS		0x800000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KASAN_HW_TAGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_SKIP_ZERO	0x1000000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_SKIP_KASAN	0x2000000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_SKIP_ZERO	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_SKIP_KASAN	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOLOCKDEP	0x4000000u</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ___GFP_NOLOCKDEP	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_DMA	((__force gfp_t)___GFP_DMA)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_HIGHMEM	((__force gfp_t)___GFP_HIGHMEM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_DMA32	((__force gfp_t)___GFP_DMA32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_MOVABLE	((__force gfp_t)___GFP_MOVABLE)  <span class="comment">/* ZONE_MOVABLE allowed */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_ZONEMASK	(__GFP_DMA|__GFP_HIGHMEM|__GFP_DMA32|__GFP_MOVABLE)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_RECLAIMABLE ((__force gfp_t)___GFP_RECLAIMABLE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_WRITE	((__force gfp_t)___GFP_WRITE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_HARDWALL   ((__force gfp_t)___GFP_HARDWALL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_THISNODE	((__force gfp_t)___GFP_THISNODE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_ACCOUNT	((__force gfp_t)___GFP_ACCOUNT)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_HIGH	((__force gfp_t)___GFP_HIGH)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_MEMALLOC	((__force gfp_t)___GFP_MEMALLOC)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_NOMEMALLOC ((__force gfp_t)___GFP_NOMEMALLOC)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_IO	((__force gfp_t)___GFP_IO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_FS	((__force gfp_t)___GFP_FS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_DIRECT_RECLAIM	((__force gfp_t)___GFP_DIRECT_RECLAIM) <span class="comment">/* Caller can reclaim */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_KSWAPD_RECLAIM	((__force gfp_t)___GFP_KSWAPD_RECLAIM) <span class="comment">/* kswapd can wake */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_RECLAIM ((__force gfp_t)(___GFP_DIRECT_RECLAIM|___GFP_KSWAPD_RECLAIM))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_RETRY_MAYFAIL	((__force gfp_t)___GFP_RETRY_MAYFAIL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_NOFAIL	((__force gfp_t)___GFP_NOFAIL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_NORETRY	((__force gfp_t)___GFP_NORETRY)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_NOWARN ((__force gfp_t)___GFP_NOWARN)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_COMP ((__force gfp_t)___GFP_COMP)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_ZERO ((__force gfp_t)___GFP_ZERO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_ZEROTAGS ((__force gfp_t)___GFP_ZEROTAGS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_SKIP_ZERO ((__force gfp_t)___GFP_SKIP_ZERO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_SKIP_KASAN ((__force gfp_t)___GFP_SKIP_KASAN)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Disable lockdep for GFP context tracking */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_NOLOCKDEP ((__force gfp_t)___GFP_NOLOCKDEP)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Room for N __GFP_FOO bits */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_BITS_SHIFT (26 + IS_ENABLED(CONFIG_LOCKDEP))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_BITS_MASK ((__force gfp_t)((1 &lt;&lt; __GFP_BITS_SHIFT) - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_ATOMIC (__GFP_HIGH | __GFP_KSWAPD_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_KERNEL (__GFP_RECLAIM | __GFP_IO | __GFP_FS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_KERNEL_ACCOUNT (GFP_KERNEL | __GFP_ACCOUNT)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_NOWAIT (__GFP_KSWAPD_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_NOIO (__GFP_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_NOFS (__GFP_RECLAIM | __GFP_IO)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_USER (__GFP_RECLAIM | __GFP_IO | __GFP_FS | __GFP_HARDWALL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_DMA __GFP_DMA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_DMA32 __GFP_DMA32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_HIGHUSER (GFP_USER | __GFP_HIGHMEM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_HIGHUSER_MOVABLE (GFP_HIGHUSER | __GFP_MOVABLE | __GFP_SKIP_KASAN)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_TRANSHUGE_LIGHT ((GFP_HIGHUSER_MOVABLE | __GFP_COMP | \</span></span><br><span class="line"><span class="meta">                              __GFP_NOMEMALLOC | __GFP_NOWARN) &amp;  \</span></span><br><span class="line"><span class="meta">                             ~__GFP_RECLAIM)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GFP_TRANSHUGE (GFP_TRANSHUGE_LIGHT | __GFP_DIRECT_RECLAIM)</span></span><br></pre></td></tr></table></figure>
<p>æ­¤éƒ¨åˆ†æ¥è‡ª <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.7.8/source/include/linux/gfp_types.h">https://elixir.bootlin.com/linux/v6.7.8/source/include/linux/gfp_types.h</a></p>
<p>å¦‚æœéœ€è¦å¿«é€ŸçŸ¥é“å¯¹åº”çš„å®çš„å€¼ï¼Œå¯ä»¥ç›´æ¥ç”¨C æ¥ printf</p>
<p>å¦‚GFP_KERNEL: 0x6000C0</p>
<h1 id="æ”»å‡»æ–¹æ³•">æ”»å‡»æ–¹æ³•</h1>
<ul>
<li>ROP
<ul>
<li>ret2usr</li>
<li>pt_regs</li>
<li>sycrop</li>
<li>ret2dir</li>
</ul>
</li>
<li>heap
<ul>
<li>heap spray</li>
<li>heap overflow</li>
<li>double free</li>
<li>Cross cache overflow</li>
<li>page level heap fenshui</li>
</ul>
</li>
<li>Race Condition</li>
<li>USMA</li>
<li>åŸºäºidtçš„å†…å­˜æœç´¢</li>
</ul>
<h2 id="ROP">ROP</h2>
<h3 id="ret2usr">ret2usr</h3>
<p>ç”±äºKPTIçš„å‡ºç°ï¼Œret2usrå®é™…ä¸Šå·²ç»ä¸å¯ç”¨äº†ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹ret2usrä»…ä»…æ˜¯ä¸ºäº†æ‹“å±•äº†è§£ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œret2usrçš„æ ¸å¿ƒå°±æ˜¯åˆ©ç”¨å†…æ ¸çš„ring 0æƒé™ï¼Œæ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç æ¥å®ç°ææƒã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„ret2usr ropé“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rop_chain[i++] = (<span class="type">size_t</span>)getRootPrivilige;  </span><br><span class="line">rop_chain[i++] = SWAPGS_POPFQ_RET + offset;  </span><br><span class="line">rop_chain[i++] = <span class="number">0</span>;  </span><br><span class="line">rop_chain[i++] = IRETQ + offset;  </span><br><span class="line">rop_chain[i++] = (<span class="type">size_t</span>)getRootShell;  </span><br><span class="line">rop_chain[i++] = user_cs;  </span><br><span class="line">rop_chain[i++] = user_rflags;  </span><br><span class="line">rop_chain[i++] = user_sp;  </span><br><span class="line">rop_chain[i++] = user_ss;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„getRootPriviligeå°±æ˜¯ç”¨æˆ·æ€çš„ ææƒä»£ç ã€‚</p>
<h4 id="ç»•è¿‡SMAPä¸SMEP">ç»•è¿‡SMAPä¸SMEP</h4>
<p>SMAPå’ŒSMEPæ˜¯ <code>x64</code> é™åˆ¶å†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®è®¿é—®çš„ä¸€ä¸ªæ¶æ„åŠŸèƒ½ï¼Œé€šè¿‡CR4å¯„å­˜å™¨çš„ä½ä½æ¥åˆ¤æ–­æ˜¯å¦å¼€å¯ã€‚ å¼€å¯å ä»å†…æ ¸æ€è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®ä¼šç›´æ¥panicï¼Œå› æ­¤é€šè¿‡åœ¨ROPé“¾ä¸­æ’å…¥ ä¿®æ”¹ <code>cr4</code> å¯„å­˜å™¨çš„gadgetå³å¯ç»•è¿‡</p>
<h4 id="KPTIå¦‚ä½•é™åˆ¶ret2usr">KPTIå¦‚ä½•é™åˆ¶ret2usr</h4>
<p>æœ€åè®¨è®ºä¸€ä¸‹KPTIçš„å®ç°</p>
<blockquote>
<p>When PTI is enabled, the kernel manages two sets of page tables. The first set is very similar to the single set which is present in kernels without PTI. This includes a complete mapping of userspace that the kernel can use for things like copy_to_user().<br>
Although <em>complete</em>, the user portion of the kernel page tables is crippled by setting the NX bit in the top level. This ensures that any missed kernel-&gt;user CR3 switch will immediately crash userspace upon executing its first instruction.<br>
The userspace page tables map only the kernel data needed to enter and exit the kernel. This data is entirely contained in the â€˜struct cpu_entry_areaâ€™ structure which is placed in the fixmap which gives each CPUâ€™s copy of the area a compile-time-fixed virtual address.<br>
For new userspace mappings, the kernel makes the entries in its page tables like normal. The only difference is when the kernel makes entries in the top (PGD) level. In addition to setting the entry in the main kernel PGD, a copy of the entry is made in the userspace page tablesâ€™ PGD.<br>
This sharing at the PGD level also inherently shares all the lower layers of the page tables. This leaves a single, shared set of userspace page tables to manage. One PTE to lock, one set of accessed bits, dirty bits, etcâ€¦</p>
</blockquote>
<p>KPTIç»´æŠ¤ä¸¤å¥—é¡µè¡¨ï¼Œä¸€å¥—å’Œæ²¡æœ‰å¼€å¯KPTI æ—¶çš„é¡µè¡¨ç±»ä¼¼ï¼Œæ‹¥æœ‰ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„å®Œæ•´æ˜ å°„ï¼Œè¿™æ˜¯ç»™å†…æ ¸æ€ä½¿ç”¨çš„ï¼Œä¸åŒçš„æ˜¯ï¼Œ æ­¤é¡µè¡¨å¯¹äºç”¨æˆ·æ€å†…å­˜ç©ºé—´çš„æ˜ å°„ï¼Œæ˜¯æ²¡æœ‰å¯æ‰§è¡Œæƒé™çš„ï¼Œè¿™é‡Œæƒé™çš„é™åˆ¶æ˜¯é€šè¿‡é¡µé¢æ¥å®ç°ï¼Œå› æ­¤ret2usrå¦‚æœå…³é—­äº†smapå’Œsmepï¼Œå°½ç®¡å¯ä»¥è®¿é—®åˆ°ç”¨æˆ·æ€æ•°æ®ï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œç”¨æˆ·æ€ä»£ç ï¼›</p>
<p>æ­¤å¤–ï¼Œä¾›ç»™ç”¨æˆ·æ€çš„é¡µè¡¨ï¼Œæ‹¥æœ‰ç”¨æˆ·æ€çš„å®Œæ•´æ˜ å°„å’Œå†…æ ¸çš„éƒ¨åˆ†æ˜ å°„ï¼Œè¿™éƒ¨åˆ†æ˜ å°„ä»…åŒ…å«è¿›å…¥å’Œç¦»å¼€å†…æ ¸æ€çš„ä»£ç ã€‚</p>
<h3 id="pt-regs-ä¸-KROP">pt_regs ä¸ KROP</h3>
<p>åœ¨5.xxç‰ˆæœ¬ï¼ˆç¬”è€…è¿˜æ²¡æœ‰æ£€æŸ¥å…·ä½“æ˜¯å“ªäº›ç‰ˆæœ¬ï¼‰ï¼Œæˆ–è€…é«˜ç‰ˆæœ¬æ²¡æœ‰å¼€å¯å¦‚ä¸‹é€‰é¡¹æ—¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_RANDOMIZE_KSTACK_OFFSET</span><br></pre></td></tr></table></figure>
<p>pt_regsæ˜¯è¿›å…¥å†…æ ¸æ€æ—¶ï¼Œå‹å…¥æ ˆä¸­çš„ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span>  </span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">* C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry  </span></span><br><span class="line"><span class="comment">* unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r15;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r14;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r13;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r12;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rbp;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rbx;  </span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span>  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r11;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r10;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r9;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> r8;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rax;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rcx;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rdx;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rsi;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rdi;  </span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">* On syscall entry, this is syscall#. On CPU exception, this is error code.  </span></span><br><span class="line"><span class="comment">* On hw interrupt, it&#x27;s IRQ number:  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> orig_rax;  </span><br><span class="line"><span class="comment">/* Return frame for iretq */</span>  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rip;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> cs;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> eflags;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> rsp;  </span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> ss;  </span><br><span class="line"><span class="comment">/* top of stack page */</span>  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œè¿™äº›å†…å®¹ï¼Œç”±ç”¨æˆ·æ€çš„å¯„å­˜å™¨å†³å®šï¼Œå¯ä»¥ç”±æˆ‘ä»¬æ§åˆ¶ã€‚</p>
<p>å› æ­¤è¿™äº›éƒ¨åˆ†å¯ä»¥ç”¨äºå¸ƒç½®ROPé“¾ï¼Œ å½“åŠ«æŒåˆ°å†…æ ¸æŸä¸ªç»“æ„ä½“çš„å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œåªéœ€è¦<strong>å¯»æ‰¾åˆ°ä¸€æ¡å½¢å¦‚ â€œadd rsp, val ; retâ€ çš„ gadget ä¾¿èƒ½å¤Ÿå®Œæˆ ROP</strong></p>
<h3 id="ret2dir">ret2dir</h3>
<p>å†…æ ¸å †åŒº direct_mapping_arean å­˜åœ¨å¯¹äºæ•´ä¸ªç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Œå› æ­¤ï¼Œé€šè¿‡mmapåœ¨ç”¨æˆ·æ€å–·å°„çš„åŒ¿åé¡µé¢ï¼Œå®é™…ä¸Šä¹Ÿä»æ­¤åˆ†é…ã€‚</p>
<p>é€šè¿‡mmapå¤§é‡åˆ†é…ï¼Œå¯ä»¥è·å–åˆ° kernel ä¸Šä¸€å—è¿‘ä¹è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå› æ­¤ï¼Œé€šè¿‡ä¸æ–­å †å–·å¸ƒç½®gadgetæ»‘å—ï¼Œç„¶åéšæœºé€‰æ‹©ä¸€ä¸ªå†…æ ¸åŸºåœ°å€è¿›è¡Œæ ˆè¿ç§»ï¼Œæœ€ç»ˆå°±æœ‰å¾ˆå¤§æ¦‚ç‡å‘½ä¸­æˆ‘ä»¬å†™å…¥çš„é¡µé¢ã€‚</p>
<h3 id="sycrop">sycrop</h3>
<p>é€šè¿‡ä¸‹ç¡¬ä»¶æ–­ç‚¹åœ¨ç”¨æˆ·æ€è§¦å‘çš„æ–¹å¼ï¼Œå¯ä»¥å°†å¯„å­˜å™¨å†…å®¹æ¨é€åˆ°ä¸ <code>per_cpu_entry_area</code> å›ºå®šåç§»çš„DB stackä¸Šï¼Œè€Œåœ¨linux 6.2ä¹‹å‰ï¼Œ <code>per_cpu_entry_area</code> æ²¡æœ‰åŠ å…¥éšæœºåŒ–ï¼Œåœ°å€å›ºå®šï¼Œæ‰€ä»¥å¯ä»¥è¾¾åˆ°åœ¨å†…æ ¸å›ºå®šåœ°å€é€ ROPé“¾çš„æ‰‹æ®µ</p>
<h3 id="work-for-cpu-fn"><code>work_for_cpu_fn</code></h3>
<p>è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªtricksï¼Œåœ¨å†…æ ¸å¾ˆéš¾ROPæ—¶ï¼Œå¯ä»¥åˆ©ç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">work_for_cpu_fn</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">work_for_cpu</span> *<span class="title">wfc</span> =</span> container_of(work, <span class="keyword">struct</span> work_for_cpu, work);</span><br><span class="line">  wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨åŠ«æŒrsiçš„æƒ…å†µã€‚</p>
<p>è¿™ä¸ªå‡½æ•°å¯ä»¥å®ç°æ‰§è¡Œä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œå¹¶å°†è¿”å›å€¼ä¿å­˜</p>
<h3 id="overview-2">overview</h3>
<p>æ³¨æ„åˆ°ï¼Œä¸Šè¿°åˆ—å‡ºçš„å‡ ä¸ªæ”»å‡»æ–¹æ³•ï¼Œå®é™…ä¸Šæ ¸å¿ƒé—®é¢˜å°±æ˜¯ROPé“¾å†™åœ¨å“ªäº›åœ°æ–¹ã€‚</p>
<ul>
<li>pt_regs: å†™åœ¨å†…æ ¸æ ˆä¸Š</li>
<li>ret2dirï¼š å†™åœ¨direct mapping arena</li>
<li>sycrop</li>
</ul>
<p>ç”±äºROPå¯ä»¥å¾ˆæ–¹ä¾¿åŠ«æŒæ§åˆ¶æµï¼Œæ‰€ç”¨ä½¿ç”¨ROPæ”»å‡»å†…æ ¸æ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>commit_cred</code> è¿›è¡Œææƒ</p>
<p>é—æ†¾çš„æ˜¯ï¼Œåœ¨é«˜ç‰ˆæœ¬å†…æ ¸ï¼Œç”±äºCFIçš„å¼•å…¥ï¼Œå¾ˆå¤šæ—¶å€™éš¾ä»¥æ‰¾åˆ°å®Œå–„çš„gadgetè¿›è¡Œåˆ©ç”¨ï¼Œé™åˆ¶äº†ROPçš„ä½¿ç”¨</p>
<h2 id="heap">heap</h2>
<h3 id="UAF">UAF</h3>
<h4 id="æœ‰æ•ˆå¤§å°Objçš„UAFå’Œè‰¯å¥½çš„kmalloc-flag">æœ‰æ•ˆå¤§å°Objçš„UAFå’Œè‰¯å¥½çš„kmalloc flag</h4>
<p>è¿™é‡Œä¸»è¦æŒ‡å’Œå†…æ ¸å…³é”®ç»“æ„ä½“å­˜åœ¨åŒæ ·çš„åˆ†é…sizeå’Œflagçš„UAFï¼Œ å¦‚ <code>tty_operations</code> æˆ– <code>seq_operations</code> ç­‰ç­‰ã€‚</p>
<p>åˆ©ç”¨è¿™äº›ç»“æ„çš„UAFå¯ä»¥ç›´æ¥leak å†…æ ¸æ•°æ®æˆ–è€…åŠ«æŒæ§åˆ¶æµï¼Œè¿™ä¸ªæ”»å‡»æµç¨‹å°±ä¸èµ˜è¿°äº†ã€‚</p>
<h4 id="ä»»æ„å¤§å°çš„UAF">ä»»æ„å¤§å°çš„UAF</h4>
<p>æ¥ä¸‹æ¥è®²è¿°ä¸€ä¸‹ä»»æ„å¤§å°UAF(ä¹Ÿæ²¡æœ‰é‚£ä¹ˆä»»æ„)çš„åˆ©ç”¨</p>
<h5 id="CVE-2021-22555ï¼š-åŸºäºmsg-msgçš„å †å–·-GFP-KERNEL-ACCOUNT">CVE-2021-22555ï¼š åŸºäºmsg_msgçš„å †å–· | GFP_KERNEL_ACCOUNT</h5>
<h5 id="åŸºäºadd-keyçš„å †å–·">åŸºäºadd_keyçš„å †å–·</h5>
<h5 id="UASM">UASM</h5>
<p>è§åæ–‡UASMçš„åˆ©ç”¨</p>
<h5 id="cross-cache-UAF">cross cache UAF</h5>
<p>#TODO</p>
<h3 id="heap-overflow">heap overflow</h3>
<h4 id="åŸºç¡€overflow">åŸºç¡€overflow</h4>
<p>åŒä¸Šæ–‡ï¼Œå­˜åœ¨ç‰¹å®šç»“æ„ä½“çš„Overflowï¼Œ å› æ­¤å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ§åˆ¶ä¸€ä¸ªæœ‰æ•ˆç»“æ„ï¼Œæ­¤æ—¶çš„åˆ©ç”¨éå¸¸ç®€å•ã€‚</p>
<h4 id="cross-cache-overflow-æ‰“ç ´slabéš”ç¦»">cross_cache overflow  | æ‰“ç ´slabéš”ç¦»</h4>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œslabä¹‹é—´å­˜åœ¨éš”ç¦»ï¼Œå› æ­¤ï¼Œå¦‚æœæº¢å‡ºç‚¹åœ¨ä¸€ä¸ªç‰¹å®šsizeçš„slabï¼Œæ­¤æ—¶ï¼Œå°±æ— æ³•é€šè¿‡ç›´æ¥çš„æº¢å‡ºåŠ«æŒæ§åˆ¶æµã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿˜æ˜¯å­˜åœ¨åœ¨buddy systemæº¢å‡ºçš„åŠæ³•ã€‚</p>
<p>è€ƒè™‘åˆ°å †å–·è€—å°½buddy systemçš„ä½ä½å•é¡µå†…å­˜ï¼Œé‚£ä¹ˆä¹‹åä»slabåˆ†é…å°±ä¼šä»é«˜ä½è¿ç»­çš„é¡µé¢ä¸­åˆ‡åˆ†ï¼Œæ­¤æ—¶ï¼Œå°±å¯ä»¥ä½¿å¾—åˆ†é…çš„é¡µé¢æ¥è‡ªä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜ï¼Œæ­¤æ—¶ï¼Œå¦‚æœåœ¨æŸä¸ªé¡µé¢æœ«å°¾çš„slabæº¢å‡ºï¼Œé‚£ä¹ˆå°±å¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªé¡µé¢ã€‚</p>
<p>å¦‚æœä¸‹ä¸€ä¸ªé¡µé¢ï¼Œè¢«å¦ä¸€ä¸ªcacheç”³è¯·ç”¨æ¥åˆ†é…å¦å¤–ä¸€ç§slabï¼Œæ­¤æ—¶å°±å¯ä»¥å®ç°è·¨cacheçš„æº¢å‡ºï¼Œä»è€Œæ§åˆ¶æœ‰æ„ä¹‰çš„cache.</p>
<h5 id="åŸºäºpipe-bufferçš„æº¢å‡ºé€šè§£">åŸºäºpipe_bufferçš„æº¢å‡ºé€šè§£</h5>
<p>#TODO</p>
<h2 id="Race-condition">Race condition</h2>
<h3 id="double-feach">double feach</h3>
<p>ç”±äºå†…æ ¸æ¨¡å—æ˜¯å…¨å±€çš„ï¼Œå¦‚æœå¯¹äºå†…æ ¸æ¨¡å—çš„æ•°æ®è®¿é—®æ²¡æœ‰åŠ é”ï¼Œå°±å¾ˆæœ‰å¯èƒ½å‡ºç°ç«æ€æ¼æ´ã€‚</p>
<h3 id="userfault">userfault</h3>
<p>åœ¨linux 5.11ä»¥ä¸‹å¯ç”¨ã€‚</p>
<p>ä¸»è¦æ˜¯ç”¨æ¥è¾…åŠ©æ¡ä»¶ç«äº‰æ¼æ´ã€‚</p>
<p>userfaultæ˜¯ä¸€ä¸ªåœ¨ç”¨æˆ·æ€è¿›è¡Œç¼ºé¡µå¤„ç†æ¥å£ã€‚</p>
<p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œ race conditionçš„æ—¶é—´çª—å£æ˜¯å¾ˆçŸ­æš‚çš„ï¼Œå¦‚æœèƒ½å¤Ÿé€šè¿‡userfault å°†æ“ä½œåœä½ï¼Œå°±èƒ½å¤Ÿå°†ç«äº‰çš„æ—¶é—´çª—å£æ‰©å¤§ï¼Œå®ç°ç«äº‰ã€‚</p>
<h3 id="fuse">fuse</h3>
<p>// é€šè¿‡CVEåˆ†æfuseçš„åˆ©ç”¨<br>
#TODO</p>
<h2 id="UASM-2">UASM</h2>
<p>æ¥è‡ª <a target="_blank" rel="noopener" href="https://vul.360.net/archives/391">https://vul.360.net/archives/391</a> çš„åˆ©ç”¨</p>
<p>è¿™ä¸ªåˆ©ç”¨ç¬”è€…æœ€åˆæœ‰ç‚¹çŠ¹è±«æ”¾åœ¨å“ªä¸ªéƒ¨åˆ†ã€‚</p>
<p>æœ€åç¬”è€…è¿˜æ˜¯å†³å®šå°†å†…å®¹å•ç‹¬åˆ—ä¸€ä¸ªäºŒçº§ç›®å½•ï¼Œå› ä¸ºç¬”è€…è®¤ä¸ºè¿™ä»£è¡¨äº†ä¸€ç§æ–°çš„åˆ©ç”¨æ–¹æ³•ï¼Œ ä¸ä»…ä»…æ˜¯ pg_vecï¼Œ åœ¨io_uringä¸­ï¼ŒåŒæ ·å­˜åœ¨ç€å†…æ ¸å’Œç”¨æˆ·åœ°å€çš„å…±åŒæ˜ å°„ï¼Œæœ‰æ²¡æœ‰å¯èƒ½ä¹Ÿåˆ©ç”¨æ­¤æ¥åˆ©ç”¨å‘¢ã€‚</p>
<p>ç”šè‡³ç›´æ¥å¯¹å†…æ ¸é¡µè¡¨è¿›è¡Œä¿®æ”¹ï¼Œå®é™…ä¸Šä¹Ÿå¯ä»¥å½’ç»“ä¸ºè¿™ç§åˆ©ç”¨çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥çš„ï¼Œ ç¬”è€…è®¤ä¸ºï¼ŒUASM ä¹Ÿè®¸å¯ä»¥ç”¨åœ¨page level uafä¸­ï¼ˆç”±äºç¬”è€…å¤ªèœäº†ï¼Œæš‚æ—¶å…ˆç ç€ï¼‰ã€‚</p>
<p>ç®€å•è€Œè¨€ï¼Œåœ¨åˆ›å»ºsocketå¹¶è®¾ç½®packetåï¼Œæ­¤æ—¶ï¼Œå†…æ ¸ç»´æŠ¤ä¸€ä¸ª <code>pg_vec</code> æ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ•°ç»„åœ°å€å¯¹åº”ç€ä¸€ä¸ªè™šæ‹Ÿåœ°å€ã€‚</p>
<p>æ­¤æ—¶ï¼Œå¦‚æœèƒ½å¤Ÿé€šè¿‡UAFæˆ–è€…æº¢å‡ºä¿®æ”¹pg_vecï¼Œ ç„¶åå†åœ¨ç”¨æˆ·æ€è°ƒç”¨mmapï¼Œå†…æ ¸å®é™…ä¸Š:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/net/packet/af_packet.c</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_mmap</span><span class="params">(file, sock, vma)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">for</span> (rb = &amp;po-&gt;rx_ring; rb &lt;= &amp;po-&gt;tx_ring; rb++) &#123;</span><br><span class="line">       <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rb-&gt;pg_vec_len; i++) &#123;</span><br><span class="line">           <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">           <span class="type">void</span> *kaddr = rb-&gt;pg_vec[i].buffer;</span><br><span class="line">           <span class="keyword">for</span> (pg_num = <span class="number">0</span>; pg_num &lt; rb-&gt;pg_vec_pages; pg_num++) &#123;               page = pgv_to_page(kaddr);</span><br><span class="line">               err = vm_insert_page(vma, start, page);</span><br><span class="line">               <span class="keyword">if</span> (unlikely(err))           </span><br><span class="line">                   <span class="keyword">goto</span> out;     </span><br><span class="line">               start += PAGE_SIZE;</span><br><span class="line">              kaddr += PAGE_SIZE;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>vm_insert_page</code> å°†è¿™äº›é¡µï¼Œæ’å…¥äº†ç”¨æˆ·æ€åœ°å€ç©ºé—´ã€‚</p>
<p>è¿™äº›é¡µéœ€è¦æ»¡è¶³å¦‚ä¸‹è¦æ±‚</p>
<ul>
<li>pageä¸ä¸ºåŒ¿åé¡µ</li>
<li>ä¸ä¸ºSlabå­ç³»ç»Ÿåˆ†é…çš„é¡µ</li>
<li>pageä¸å«æœ‰type</li>
</ul>
<p>è¿™å°±é™åˆ¶äº†ä½¿ç”¨å†…æ ¸å †çš„é¡µé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/mm/memory.c</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">validate_page_before_insert</span><span class="params">(<span class="keyword">struct</span> page *page)</span>           </span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">if</span> (PageAnon(page) || PageSlab(page) || page_has_type(page))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;      </span><br><span class="line">    flush_dcache_page(page);        </span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;      </span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œpg_vecåŸæ¥çš„è™šæ‹Ÿåœ°å€åŸæ¥çš„æƒé™æ˜¯æ— æ‰€è°“çš„ï¼Œå› ä¸ºå¹¶æ²¡æœ‰å¯¹åŸæ¥è™šæ‹Ÿåœ°å€çš„å†…å­˜æƒé™ï¼ˆä¹Ÿå³è¿™ä¸ªé¡µè¡¨é¡¹çš„å†…å­˜æƒé™ï¼‰è¿›è¡Œæ£€æŸ¥ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹å†…æ ¸ä»£ç æ®µæˆ–è€…å†…æ ¸æ¨¡å—ä»£ç æ®µã€æ•°æ®æ®µã€‚<br>
è€Œä¸”çº¿æ€§æ˜ å°„åŒºåŸŸå­˜åœ¨å†…æ ¸çš„å…¨éƒ¨æ˜ å°„ï¼Œå¯ä»¥åœ¨è¿™ä¸ªåœ°å€èŒƒå›´æ‰¾åˆ°ä¸Šè¿°é¡µé¢ã€‚</p>
<p>æ›´å¦™çš„æ˜¯ï¼Œpg_vecå¯ä»¥ç”±ç”¨æˆ·æ€å†³å®šï¼Œä¸è¿‡å…¶åˆ†é…flagæ˜¯<code>GFP_KERNEL</code></p>
<p>ç›¸æ¯”äºROPï¼Œåˆ©ç”¨æ›´åŠ ç®€å•ï¼Œå¹¶ä¸”ä¸å—CFIçš„å½±å“ã€‚</p>
<h2 id="dirtypagetable">dirtypagetable</h2>
<p>#TODO</p>
<h2 id="POP-page-level-ROP">POP | page level ROP</h2>
<p>æ¥è‡ªblachhat2021çš„ä¸€ç§æ€è·¯ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ‹“å±•è„‘æ´ï¼Œå®é™…åˆ©ç”¨èµ·æ¥ä¸å¦‚UASMç›´æ¥æ”¹å†…æ ¸ä»£ç æ–¹ä¾¿ã€‚ä½†æ˜¯å¾ˆæœ‰ä¼ ç»Ÿåˆ©ç”¨çš„ç¾æ„Ÿã€‚</p>
<p>#TODO</p>
<h2 id="tricks">tricks</h2>
<ul>
<li>åŸºäºinterç¡¬ä»¶æ¼æ´çš„leak tricks</li>
<li>åœ¨å†…æ ¸â€œå †åŸºå€â€ï¼ˆ<code>page_offset_base</code>ï¼‰ +Â <code>0x9d000</code>Â å¤„å­˜æ”¾ç€Â <code>secondary_startup_64</code>Â å‡½æ•°çš„åœ°å€</li>
</ul>
<h2 id="ä»CTFåˆ°å®æˆ˜åˆ©ç”¨çš„å“²æ€">ä»CTFåˆ°å®æˆ˜åˆ©ç”¨çš„å“²æ€</h2>
<p>#TODO</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/Linux.io_uring-Top-down-Approach/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-03-03 16:21:36
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Pwn/" title="Pwn">
                        <b>#</b> Pwn
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Pwn/" title="Pwn">
                        #Pwn
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/linux/" title="linux">
                        #linux
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/CTF/" title="CTF">
                        #CTF
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Kernel/" title="Kernel">
                        #Kernel
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/Fuzz.AFL-All-in-One/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#overview"><span class="toc-text">overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="toc-text">å®‰å…¨æœºåˆ¶</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86"><span class="toc-text">ä¿¡æ¯æœé›†</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Target"><span class="toc-text">Target</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#modify-cred"><span class="toc-text">modify cred</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%AE%9A%E4%BD%8Dcred"><span class="toc-text">ç›´æ¥å®šä½cred</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-creds"><span class="toc-text">commit_creds</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#prepare-kernel-cred"><span class="toc-text">prepare_kernel_cred()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init-cred"><span class="toc-text">init_cred</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#modprobe-path"><span class="toc-text">modprobe_path</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%AE%9A%E4%BD%8D"><span class="toc-text">ç›´æ¥å®šä½</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%97%B4%E6%8E%A5%E5%AE%9A%E4%BD%8D"><span class="toc-text">é—´æ¥å®šä½</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#poweroff-cmd"><span class="toc-text">poweroff_cmd</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%AE%8F"><span class="toc-text">ä¸€äº›å®</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95"><span class="toc-text">æ”»å‡»æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP"><span class="toc-text">ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2usr"><span class="toc-text">ret2usr</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87SMAP%E4%B8%8ESMEP"><span class="toc-text">ç»•è¿‡SMAPä¸SMEP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KPTI%E5%A6%82%E4%BD%95%E9%99%90%E5%88%B6ret2usr"><span class="toc-text">KPTIå¦‚ä½•é™åˆ¶ret2usr</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pt-regs-%E4%B8%8E-KROP"><span class="toc-text">pt_regs ä¸ KROP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2dir"><span class="toc-text">ret2dir</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sycrop"><span class="toc-text">sycrop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#work-for-cpu-fn"><span class="toc-text">work_for_cpu_fn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#overview-2"><span class="toc-text">overview</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#heap"><span class="toc-text">heap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UAF"><span class="toc-text">UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%89%E6%95%88%E5%A4%A7%E5%B0%8FObj%E7%9A%84UAF%E5%92%8C%E8%89%AF%E5%A5%BD%E7%9A%84kmalloc-flag"><span class="toc-text">æœ‰æ•ˆå¤§å°Objçš„UAFå’Œè‰¯å¥½çš„kmalloc flag</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%A4%A7%E5%B0%8F%E7%9A%84UAF"><span class="toc-text">ä»»æ„å¤§å°çš„UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CVE-2021-22555%EF%BC%9A-%E5%9F%BA%E4%BA%8Emsg-msg%E7%9A%84%E5%A0%86%E5%96%B7-GFP-KERNEL-ACCOUNT"><span class="toc-text">CVE-2021-22555ï¼š åŸºäºmsg_msgçš„å †å–· | GFP_KERNEL_ACCOUNT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eadd-key%E7%9A%84%E5%A0%86%E5%96%B7"><span class="toc-text">åŸºäºadd_keyçš„å †å–·</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UASM"><span class="toc-text">UASM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cross-cache-UAF"><span class="toc-text">cross cache UAF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#heap-overflow"><span class="toc-text">heap overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80overflow"><span class="toc-text">åŸºç¡€overflow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cross-cache-overflow-%E6%89%93%E7%A0%B4slab%E9%9A%94%E7%A6%BB"><span class="toc-text">cross_cache overflow  | æ‰“ç ´slabéš”ç¦»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Epipe-buffer%E7%9A%84%E6%BA%A2%E5%87%BA%E9%80%9A%E8%A7%A3"><span class="toc-text">åŸºäºpipe_bufferçš„æº¢å‡ºé€šè§£</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Race-condition"><span class="toc-text">Race condition</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#double-feach"><span class="toc-text">double feach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#userfault"><span class="toc-text">userfault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fuse"><span class="toc-text">fuse</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UASM-2"><span class="toc-text">UASM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dirtypagetable"><span class="toc-text">dirtypagetable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP-page-level-ROP"><span class="toc-text">POP | page level ROP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tricks"><span class="toc-text">tricks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8ECTF%E5%88%B0%E5%AE%9E%E6%88%98%E5%88%A9%E7%94%A8%E7%9A%84%E5%93%B2%E6%80%9D"><span class="toc-text">ä»CTFåˆ°å®æˆ˜åˆ©ç”¨çš„å“²æ€</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/Du-Mu">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright Â© 2024 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
    <div class="footer-views">
      
          æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
        
      
          æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡
        
      
          æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Pwn.Linux-Kernel-Pwn-All-in-One + '&url=' + https%3A%2F%2Fv3rdant.cn%2FPwn.Linux-Kernel-Pwn-All-in-One%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://v3rdant.cn/Pwn.Linux-Kernel-Pwn-All-in-One/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
